# AMP Management

See (http://docs.alfresco.com/5.0/tasks/alfresco-sdk-advanced-add-custom-amps-aio.html)
for general documentation on adding new AMPs to SDK AIO projects. Here are the specific
steps that are used with the generator-alfresco for managing the AMPS within the project.

## Adding, Removing, Renaming an AMP

An AMP can be generated by using the following sub-generator.

```text
yo alfresco:amp
```

You will be prompted to perform an action:

### Add Source

```text
? Add, Remove, reName source AMP? (A/R/N) A
? Would you like to create a repo or share AMP? (use arrow keys)
>repo
 share
? Type of module
>src
 pre-packaged local
 pre-packaged remote
? Module groupId? <default to current project groupId>
? Module artifactId? (will be used as module Id as well)
? Module version? 
```

### Add Pre-Packaged Local

```text
? Add, Remove, reName source AMP? (A/R/N) A
? Would you like to create a repo or share AMP? (use arrow keys)
>repo
 share
? Type of module
src
>pre-packaged local
pre-packaged remote
? Module groupId?
? Module artifactId?
? Module version? 
? Select AMP file
>jsconsole-repo-0.6.0.amp
 bfsit-repo-1.3.4.amp
```

### Add Pre-Packaged Remote

```text
? Add, Remove, reName source AMP? (A/R/N) A
? Would you like to create a repo or share AMP? (use arrow keys)
>repo
 share
? Type of module
 src
 pre-packaged local
>pre-packaged remote
? Module groupId?
? Module artifactId?
? Module version? 
```

### Remove

```text
? Add, Remove, reName source AMP? (A/R/N) R
? Which module would you like to remove? (use arrow keys)
>repo-amp (source)
 share-amp (source)
```
### Rename

```text
? Add, Remove, reName source AMP? (A/R/N) N
? Which module would you like to rename? (use arrow keys)
>repo-amp
 share-amp
? Module groupId? <default to current value>
? Module artifactId? <default to current value>
? Module version? <default to current value>
```


### Steps the sub-generator takes when adding a new Alfresco (repo) AMP

1. Make sure that /amps_source/*artifactId* doesn't exist. Throw error if it does.
2. Create /amps_source/*artifactId* folder 
3. Copy /amps_source_templates/repo-amp/\* to /amps_source/*artifactId*
4. Rename folder /amps_source/*artifactId*/src/main/amp/config/alfresco/module/**repo-amp** to **artifactId**
5. Add module reference to /pom.xml by adding \<module>*artifactId*\</module> to the \<modules> element

   ~~~xml
   <modules>
     <module>ARTIFACTID</module>
     <!-- out of the box modules -->
     <module>repo</module>
     <module>solr-config</module>
     <module>share</module>
     <module>runner</module>
   </modules>
   ~~~
   
6. Edit /amps_source/*artifactId*/pom.xml
   1. Update the \<artifactId>, \<name>, and \<description> elements with the new *artifactId*
   
      ~~~xml
      <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
          xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
        <modelVersion>4.0.0</modelVersion>
        <artifactId>ARTIFACTID</artifactId>
        <name>ARTIFACTID</name>
        ...
        <description>ARTIFACTID</description>
      </project>  
      ~~~
      
7. Edit /repo/pom.xml
   1. Edit the \<dependencies> and add the new module dependency
   
      ~~~xml
      <dependencies>
        ...
        <dependency>
          <groupId>${project.groupId}</groupId>
          <artifactId>ARTIFACTID</artifactId>
          <version>${project.version}</version>
          <type>amp</type>
        </dependency>
        ...
      </dependencies> 
      ~~~
      
   2. Edit the \<overlays> and add the new overlay
   
      ~~~xml
      <overlays>
        <!-- Current project customizations. This is normally empty, since customizations come from the AMPs -->
        <overlay/>
        <!-- The Alfresco WAR -->
        <overlay>
          <groupId>${alfresco.groupId}</groupId>
          <artifactId>${alfresco.repo.artifactId}</artifactId>
          <type>war</type>
          <!-- To allow inclusion of META-INF -->
          <excludes/>
        </overlay>
               
        <!-- Add / sort your AMPs here -->
        <overlay>
          <groupId>${project.groupId}</groupId>
          <artifactId>ARTIFACTID</artifactId>
          <type>amp</type>
        </overlay>
        ... 
      </overlays>
      ~~~

8. Edit /runner/tomcat/context-repo.xml
   1. Edit the \<Resources> element and update the extraResourcePaths attribute adding your target web folder   
   
      ~~~xml
      <Context docBase="${project.parent.basedir}/alfresco-war/target/${project.build.finalName}">
        <!-- Pick up static resource files from AMPs and other directories (this should not include docBase) -->
        <Resources className="org.apache.naming.resources.VirtualDirContext"
                   extraResourcePaths="/=${project.parent.basedir}/amps_source/ARTIFACTID/target/ARTIFACTID/web" />   
        ...
      </Context>
      ~~~
      
      If there is already another resource path to an amp target \(e.g. OtherAMPName) add yours to the end with a 
      comma seperator.
      
      ~~~xml
      <Context docBase="${project.parent.basedir}/alfresco-war/target/${project.build.finalName}">
        <!-- Pick up static resource files from AMPs and other directories (this should not include docBase) -->
        <Resources className="org.apache.naming.resources.VirtualDirContext"
                   extraResourcePaths="/=${project.parent.basedir}/amps_source/OtherAMPName/target/OtherAMPName/web,
                                       /=${project.parent.basedir}/amps_source/ARTIFACTID/target/ARTIFACTID/web" />   
        ...
      </Context>
      ~~~
      
   2. Edit the \<Loader> element and the virtualClassPath attribute and point it to the classes, config, and 
      test-classes folders for your *artifactId*.
      
      ~~~xml
      <!-- Setup the virtual class path like this:
           1) target/classes
           2) target/${project.build.finalName}/config
           3) target/test-classes
      
           This way mvn compile can be invoked and all changes will be picked up
      -->
      <Loader className="org.apache.catalina.loader.VirtualWebappLoader"
              searchVirtualFirst="true"
              virtualClasspath="${project.parent.basedir}/amps_source/ARTIFACTID/target/classes;
                                ${project.parent.basedir}/amps_source/ARTIFACTID/target/ARTIFACTID/config;
                                ${project.parent.basedir}/amps_source/ARTIFACTID/target/test-classes" />
      ~~~
         
      If there is already other paths there say to an amp target \(e.g. OtherAMPName) add yours to the end with a 
      semicolon separator.
      
      ~~~xml
      <!-- Setup the virtual class path like this:
           1) target/classes
           2) target/${project.build.finalName}/config
           3) target/test-classes
      
           This way mvn compile can be invoked and all changes will be picked up
      -->
      <Loader className="org.apache.catalina.loader.VirtualWebappLoader"
              searchVirtualFirst="true"
              virtualClasspath="${project.parent.basedir}/amps_source/OtherAMPName/target/classes;
                                ${project.parent.basedir}/amps_source/OtherAMPName/target/OtherAMPName/config;
                                ${project.parent.basedir}/amps_source/OtherAMPName/target/test-classes;
                                ${project.parent.basedir}/amps_source/ARTIFACTID/target/classes;
                                ${project.parent.basedir}/amps_source/ARTIFACTID/target/ARTIFACTID/config;
                                ${project.parent.basedir}/amps_source/ARTIFACTID/target/test-classes" />
      ~~~
      
9. Internal step within code

   Internal to the yeoman generator, the .yo-rc.json file is updated. There is a "moduleRegistry" section here that keeps
   track of modules that the alfresco generator adds.

### Steps the sub-generator takes when adding a new Share AMP

1. Make sure that /amps_source/*artifactId* doesn't exist. Throw error if it does
2. Create /amps_source/*artifactId* folder
3. Copy /amps_source_templates/share-amp/* to /amps_source/*artifactId*
4. Rename /amps_source/*artifactId*/src/main/amp/config/alfresco/module/**share-amp** to *artifactId*
5. Edit /pom.xml to reference new AMP adding \<module>*artifactId*\</module> to \<modules>

   ~~~xml
   <modules>
     <module>ARTIFACTID</module>
     <!-- out of the box modules -->
     <module>repo</module>
     <module>solr-config</module>
     <module>share</module>
     <module>runner</module>
   </modules>
   ~~~
   
6. Edit /amps_source/*artifactId*/pom.xml
   1. Update the \<artifactId>, \<name>, and \<description> elements with the new *artifactId*
   
      ~~~xml
      <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
          xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd">
        <modelVersion>4.0.0</modelVersion>
        <artifactId>ARTIFACTID</artifactId>
        <name>ARTIFACTID</name>
        <description>AMPName</description>
        ...
      </project>
      ~~~
      
7. Edit share/pom.xml
   1. Edit the \<dependencies> and add the new module dependency
   
      ~~~xml
      <dependencies>
        ...
        <dependency>
          <groupId>${project.groupId}</groupId>
          <artifactId>ARTIFACTID</artifactId>
          <version>${project.version}</version>
          <type>amp</type>
        </dependency>
        ...
      </dependencies>
      ~~~
      
   2. Edit the \<overlays> and add the new overlay (right after Add / sort your AMPs here)
   
      ~~~xml
      <overlays>
        <!-- The current project customizations -->
        <overlay/>
        <!-- The Share WAR -->
        <overlay>
          <groupId>${alfresco.groupId}</groupId>
          <artifactId>${alfresco.share.artifactId}</artifactId>
          <type>war</type>
          <!-- To allow inclusion of META-INF -->
          <excludes/>
        </overlay>
        
        <!-- Add / sort your AMPs here -->
        <overlay>
          <groupId>${project.groupId}</groupId>
          <artifactId>ARTIFACTID</artifactId>
          <type>amp</type>
        </overlay>
        ...
      </overlays>
      ~~~
      
8. Edit /runner/tomcat/context-share.xml
   1. Edit the \<Resources> element and update the extraResourcePaths attribute adding your target web folder   
   
      ~~~xml
      <Context>
        <!-- Pick up static resource files from any Share extensions, being it a JAR or an AMP
             (this should not include docBase) -->
        <Resources className="org.apache.naming.resources.VirtualDirContext"
                   extraResourcePaths="/=${project.parent.basedir}/amps_source/ARTIFACTID/target/ARTIFACTID/web" />
      </Context>
      ~~~
   
      If there is already another resource path to an amp target \(e.g. OtherAMPName) add yours to the end with a comma seperator.
      
      ~~~xml
      <Context docBase="${project.parent.basedir}/alfresco-war/target/${project.build.finalName}">
         <!-- Pick up static resource files from AMPs and other directories (this should not include docBase) -->
         <Resources className="org.apache.naming.resources.VirtualDirContext"
               extraResourcePaths="/=${project.parent.basedir}/amps_source/OtherAMPName/target/OtherAMPName/web,
                                   /=${project.parent.basedir}/amps_source/ARTIFACTID/target/ARTIFACTID/web" />
      ~~~
      
   2. Edit the \<Loader> element and the virtualClassPath attribute and point it to the classes, config, and test-classes folders
   for your AMPName.
   
      ~~~xml
      <!-- Configure where the Share (share.war) web application can load classes, config, and test classes (in that order) -->
      <!-- Setup the virtual class path like this:
           1) share-amp/target/classes
           2) share-amp/target/${project.build.finalName}/config
           3) share-amp/target/test-classes
           4)     Add other AMP paths here....
           5) share/target/test-classes              (loads the share-config-custom.xml used during test runs)
   
           This way mvn compile can be invoked and all changes will be picked up
      -->
      <Loader className="org.apache.catalina.loader.VirtualWebappLoader"
              searchVirtualFirst="true"
              virtualClasspath="${project.parent.basedir}/amps_source/ARTIFACTID/target/classes;
                                ${project.parent.basedir}/amps_source/ARTIFACTID/target/share-amp/config;
                                ${project.parent.basedir}/amps_source/ARTIFACTID/target/test-classes" />
      ~~~
   
      If there is already other paths there say to an amp target \(e.g. OtherAMPName) add yours to the end with a semicolon seperator.
   
      ~~~xml
      <!-- Configure where the Share (share.war) web application can load classes, config, and test classes (in that order) -->
      <!-- Setup the virtual class path like this:
           1) share-amp/target/classes
           2) share-amp/target/${project.build.finalName}/config
           3) share-amp/target/test-classes
           4)     Add other AMP paths here....
           5) share/target/test-classes              (loads the share-config-custom.xml used during test runs)
   
           This way mvn compile can be invoked and all changes will be picked up
      -->
      <Loader className="org.apache.catalina.loader.VirtualWebappLoader"
              searchVirtualFirst="true"
              virtualClasspath="${project.parent.basedir}/amps_source/OtherAMPName/target/classes;
                                ${project.parent.basedir}/amps_source/OtherAMPName/target/share-amp/config;
                                ${project.parent.basedir}/amps_source/OtherAMPName/target/test-classes;
                                ${project.parent.basedir}/amps_source/ARTIFACTID/target/classes;
                                ${project.parent.basedir}/amps_source/ARTIFACTID/target/share-amp/config;
                                ${project.parent.basedir}/amps_source/ARTIFACTID/target/test-classes" />
      ~~~
      
9. Internal step within code

   Internal to the yeoman generator, the .yo-rc.json file is updated. There is a "moduleRegistry" section here that keeps
   track of modules that the alfresco generator adds.


# TODO
* In Add Source section, do we even need to prompt for group or version as they typically default from the parent?
* Currently the top level generator removes samples before it makes copies for the template. Should it do that? 
  Do we want to have an option to add/remove samples?
* Need to add an update for functional-testing for runner/pom.xml
* Edit runner/pom.xml (for Share)
  * Update the maven-failsafe-plugin in the functional-testing profile to specify the functional tests for
    the new AMP. The 2.x SDK puts the \<configuration\> block above the \<execution\> blocks for testing, 
    thus you can only specify a single share AMP test in here. It should be moved more appropriately.
